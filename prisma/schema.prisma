// Prisma Schema for AI Novel Web (Simplified Local Version)
// https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./data.db"
}

// ==================== User (Simplified) ====================

model User {
  id        String   @id @default(cuid())
  shortId   Int?     @unique @map("short_id")
  nickname  String?
  avatar    String?

  novels          Novel[]
  aiLogs          AIGenerationLog[]
  activities      UserActivity[]
  generatedImages GeneratedImage[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("users")
}

// ==================== Novel & Chapter ====================

model Novel {
  id     String @id @default(cuid())
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  title       String
  description String?
  coverUrl    String?  @map("cover_url")
  status      String   @default("active") // active, archived
  tags        String?  // comma-separated: "现代,都市,情感"
  totalWords  Int      @default(0) @map("total_words")
  metadata    Json?    // settings, ai params
  summary     String?  // 全书概要，用于 AI 上下文

  chapters         Chapter[]
  cards            Card[]
  aiLogs           AIGenerationLog[]
  outlineNodes     OutlineNode[]
  chapterSummaries ChapterSummary[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@map("novels")
}

model Chapter {
  id      String @id @default(cuid())
  novelId String @map("novel_id")
  novel   Novel  @relation(fields: [novelId], references: [id], onDelete: Cascade)

  number      Int
  title       String
  content     String
  wordCount   Int     @default(0) @map("word_count")
  status      String  @default("published") // "published" | "draft"
  aiGenerated Boolean @default(false) @map("ai_generated")
  aiModel     String? @map("ai_model")

  aiLogs       AIGenerationLog[]
  outlineNodes OutlineNode[]
  summary      ChapterSummary?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([novelId])
  @@map("chapters")
}

// ==================== Chapter Summary ====================

model ChapterSummary {
  id        String  @id @default(cuid())
  novelId   String  @map("novel_id")
  novel     Novel   @relation(fields: [novelId], references: [id], onDelete: Cascade)
  chapterId String  @unique @map("chapter_id")
  chapter   Chapter @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  summary    String  // 摘要内容
  keyPoints  String? @map("key_points") // JSON 格式存储：["伏笔A", "角色B登场"]
  tokenCount Int?    @map("token_count")
  isManual   Boolean  @default(false) @map("is_manual")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([novelId])
  @@map("chapter_summaries")
}

// ==================== Card (角色/物品/设定卡片) ====================

model Card {
  id      String @id @default(cuid())
  novelId String @map("novel_id")
  novel   Novel  @relation(fields: [novelId], references: [id], onDelete: Cascade)

  name        String
  category    String   // character, item, skill, location, faction, event, term
  description String?
  avatar      String?
  tags        String?
  triggers    String?  @map("triggers") // JSON 格式存储触发词数组
  sortOrder   Int      @default(0) @map("sort_order")
  isPinned    Boolean  @default(false) @map("is_pinned")
  attributes  Json?    // 扩展属性

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([novelId])
  @@index([category])
  @@map("cards")
}

// ==================== AI Generation Log ====================

model AIGenerationLog {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  novelId   String?  @map("novel_id")
  novel     Novel?   @relation(fields: [novelId], references: [id], onDelete: SetNull)
  chapterId String?  @map("chapter_id")
  chapter   Chapter? @relation(fields: [chapterId], references: [id], onDelete: SetNull)

  aiModel             String  @map("ai_model")
  storyBackground     String? @map("story_background")
  chapterPlot         String? @map("chapter_plot")
  writingStyle        String? @map("writing_style")
  writingRequirements String? @map("writing_requirements")

  linkedCardIds      String? @map("linked_card_ids")
  linkedChapterIds   String? @map("linked_chapter_ids")
  autoLinkRange      Int?    @map("auto_link_range")
  characterRelations String? @map("character_relations")

  inputTokens    Int? @map("input_tokens")
  outputTokens   Int? @map("output_tokens")
  thoughtsTokens Int? @map("thoughts_tokens")
  totalTokens    Int? @map("total_tokens")

  thinking         String?
  generatedContent String? @map("generated_content")
  isAccepted       Boolean @default(false) @map("is_accepted")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([novelId])
  @@index([chapterId])
  @@map("ai_generation_logs")
}

// ==================== Generated Image ====================

model GeneratedImage {
  id     String @id @default(cuid())
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type     String // background, cover
  imageUrl String @map("image_url")

  title  String?
  author String?
  prompt String?

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@map("generated_images")
}

// ==================== User Activity ====================

model UserActivity {
  id     String @id @default(cuid())
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type        String
  title       String
  description String
  metadata    Json?
  isRead      Boolean @default(false) @map("is_read")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([createdAt])
  @@map("user_activities")
}

// ==================== Settings (本地设置) ====================

model Settings {
  id    String @id @default(cuid())
  key   String @unique
  value String

  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("settings")
}

// ==================== Outline (大纲系统) ====================

model OutlineNode {
  id      String @id @default(cuid())
  novelId String @map("novel_id")
  novel   Novel  @relation(fields: [novelId], references: [id], onDelete: Cascade)

  parentId String?       @map("parent_id")
  parent   OutlineNode?  @relation("OutlineHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children OutlineNode[] @relation("OutlineHierarchy")

  linkedChapterId String?  @map("linked_chapter_id")
  linkedChapter   Chapter? @relation(fields: [linkedChapterId], references: [id], onDelete: SetNull)

  title     String
  content   String?
  type      String  // 'volume' | 'chapter_outline' | 'plot_point'
  sortOrder Int     @default(0) @map("sort_order")
  completed Boolean @default(false)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([novelId])
  @@index([parentId])
  @@index([linkedChapterId])
  @@map("outline_nodes")
}
